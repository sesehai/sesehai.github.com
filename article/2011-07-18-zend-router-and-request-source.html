<!DOCTYPE html>
<html>
<head>
<title>Zend Framework Router And Request 源码</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link type="image/ico" rel="shortcut icon" href="favicon.ico"/>
<link rel="Stylesheet" type="text/css" href="../style.css" />
<script>var root_path = '';</script>
</head>
<body>
<div id="all">
<div id="header">
	<ul id="top-nav">
		<li>
			<a href="../index.html">(@_@) 海的心情</a>
		</li>
		<li>
			<a href="../archive/">文档</a>
		</li>
		<li>
			<a href="../article/">文摘</a>
		</li>
		<li>
			<a href="../diary/diary.html">日记</a>
		</li>
		<li>
			<a href="../sites.html">Sites</a>
		</li>
	</ul>
</div>
<div id="cse"></div>
<div id="main">

<div class="toc">
<ul>
<li><a href="#toc_0.1">Zend Fromwork Router And Request 源码</a>
<ul>
<li><a href="#toc_0.1.1">class Zend_Controller_Router_Rewrite extends Zend_Controller_Router_Abstract</a>
<li><a href="#toc_0.1.2">class Zend_Controller_Router_Route_Module extends Zend_Controller_Router_Route_Abstract</a>
<li><a href="#toc_0.1.3">class Zend_Controller_Request_Http extends Zend_Controller_Request_Abstract</a>
</ul>
</ul>
</ul>
</div>
<h2 id="toc_0.1">Zend Fromwork Router And Request 源码</h2>
<p>
<em>2011-07-18</em>
</p>

<h3 id="toc_0.1.1">class Zend_Controller_Router_Rewrite extends Zend_Controller_Router_Abstract</h3>

<pre  class="brush:php">
    /**
     * Find a matching route to the current PATH_INFO and inject
     * returning values to the Request object.
     *
     * @throws Zend_Controller_Router_Exception
     * @return Zend_Controller_Request_Abstract Request object
     */
    public function route(Zend_Controller_Request_Abstract $request)
    {

        if (!$request instanceof Zend_Controller_Request_Http) {
            require_once 'Zend/Controller/Router/Exception.php';
            throw new Zend_Controller_Router_Exception('Zend_Controller_Router_Rewrite requires a Zend_Controller_Request_Http-based request object');
        }

        if ($this-&gt;_useDefaultRoutes) {
            $this-&gt;addDefaultRoutes();
        }

        /** Find the matching route */
        foreach (array_reverse($this-&gt;_routes) as $name =&gt; $route) {
            
            // TODO: Should be an interface method. Hack for 1.0 BC  
            if (!method_exists($route, 'getVersion') || $route-&gt;getVersion() == 1) {
                $match = $request-&gt;getPathInfo();
            } else {
                $match = $request;
            }
                        
            if ($params = $route-&gt;match($match)) {
                $this-&gt;_setRequestParams($request, $params);
                $this-&gt;_currentRoute = $name;
                break;
            }
        }

        return $request;

    }
</pre>


<h3 id="toc_0.1.2">class Zend_Controller_Router_Route_Module extends Zend_Controller_Router_Route_Abstract</h3>

<pre  class="brush:php">
   /**
     * Set request keys based on values in request object
     *
     * @return void
     */
    protected function _setRequestKeys()
    {
        if (null !== $this-&gt;_request) {
            $this-&gt;_moduleKey     = $this-&gt;_request-&gt;getModuleKey();
            $this-&gt;_controllerKey = $this-&gt;_request-&gt;getControllerKey();
            $this-&gt;_actionKey     = $this-&gt;_request-&gt;getActionKey();
        }

        if (null !== $this-&gt;_dispatcher) {
            $this-&gt;_defaults += array(
                $this-&gt;_controllerKey =&gt; $this-&gt;_dispatcher-&gt;getDefaultControllerName(),
                $this-&gt;_actionKey     =&gt; $this-&gt;_dispatcher-&gt;getDefaultAction(),
                $this-&gt;_moduleKey     =&gt; $this-&gt;_dispatcher-&gt;getDefaultModule()
            );
        }

        $this-&gt;_keysSet = true;
    }

    /**
     * Matches a user submitted path. Assigns and returns an array of variables
     * on a successful match.
     *
     * If a request object is registered, it uses its setModuleName(),
     * setControllerName(), and setActionName() accessors to set those values.
     * Always returns the values as an array.
     *
     * @param string $path Path used to match against this routing map
     * @return array An array of assigned values or a false on a mismatch
     */
    public function match($path)
    {
        $this-&gt;_setRequestKeys();

        $values = array();
        $params = array();
        $path   = trim($path, self::URI_DELIMITER);

        if ($path != '') {

            $path = explode(self::URI_DELIMITER, $path);

            if ($this-&gt;_dispatcher &amp;&amp; $this-&gt;_dispatcher-&gt;isValidModule($path[0])) {
                $values[$this-&gt;_moduleKey] = array_shift($path);
                $this-&gt;_moduleValid = true;
            }

            if (count($path) &amp;&amp; !empty($path[0])) {
                $values[$this-&gt;_controllerKey] = array_shift($path);
            }

            if (count($path) &amp;&amp; !empty($path[0])) {
                $values[$this-&gt;_actionKey] = array_shift($path);
            }

            if ($numSegs = count($path)) {
                for ($i = 0; $i &lt; $numSegs; $i = $i + 2) {
                    $key = urldecode($path[$i]);
                    $val = isset($path[$i + 1]) ? urldecode($path[$i + 1]) : null;
                    $params[$key] = (isset($params[$key]) ? (array_merge((array) $params[$key], array($val))): $val);
                }
            }
        }

        $this-&gt;_values = $values + $params;

        return $this-&gt;_values + $this-&gt;_defaults;
    }
</pre>


<h3 id="toc_0.1.3">class Zend_Controller_Request_Http extends Zend_Controller_Request_Abstract</h3>

<pre  class="brush:php">
    /**
     * Set the REQUEST_URI on which the instance operates
     *
     * If no request URI is passed, uses the value in $_SERVER['REQUEST_URI'],
     * $_SERVER['HTTP_X_REWRITE_URL'], or $_SERVER['ORIG_PATH_INFO'] + $_SERVER['QUERY_STRING'].
     *
     * @param string $requestUri
     * @return Zend_Controller_Request_Http
     */
    public function setRequestUri($requestUri = null)
    {
        if ($requestUri === null) {
            if (isset($_SERVER['HTTP_X_REWRITE_URL'])) { // check this first so IIS will catch
                $requestUri = $_SERVER['HTTP_X_REWRITE_URL'];
            } elseif (isset($_SERVER['REQUEST_URI'])) {
                $requestUri = $_SERVER['REQUEST_URI'];
                if (isset($_SERVER['HTTP_HOST']) &amp;&amp; strstr($requestUri, $_SERVER['HTTP_HOST'])) {
                    $requestUri = preg_replace('#^[^:]*://[^/]*/#', '/', $requestUri);
                }
            } elseif (isset($_SERVER['ORIG_PATH_INFO'])) { // IIS 5.0, PHP as CGI
                $requestUri = $_SERVER['ORIG_PATH_INFO'];
                if (!empty($_SERVER['QUERY_STRING'])) {
                    $requestUri .= '?' . $_SERVER['QUERY_STRING'];
                }
            } else {
                return $this;
            }
        } elseif (!is_string($requestUri)) {
            return $this;
        } else {
            // Set GET items, if available
            if (false !== ($pos = strpos($requestUri, '?'))) {
                // Get key =&gt; value pairs and set $_GET
                $query = substr($requestUri, $pos + 1);
                parse_str($query, $vars);
                $this-&gt;setQuery($vars);
            }
        }

        $this-&gt;_requestUri = $requestUri;
        return $this;
    }

    /**
     * Returns the REQUEST_URI taking into account
     * platform differences between Apache and IIS
     *
     * @return string
     */
    public function getRequestUri()
    {
        if (empty($this-&gt;_requestUri)) {
            $this-&gt;setRequestUri();
        }

        return $this-&gt;_requestUri;
    }

    /**
     * Set the base URL of the request; i.e., the segment leading to the script name
     *
     * E.g.:
     * - /admin
     * - /myapp
     * - /subdir/index.php
     *
     * Do not use the full URI when providing the base. The following are
     * examples of what not to use:
     * - http://example.com/admin (should be just /admin)
     * - http://example.com/subdir/index.php (should be just /subdir/index.php)
     *
     * If no $baseUrl is provided, attempts to determine the base URL from the
     * environment, using SCRIPT_FILENAME, SCRIPT_NAME, PHP_SELF, and
     * ORIG_SCRIPT_NAME in its determination.
     *
     * @param mixed $baseUrl
     * @return Zend_Controller_Request_Http
     */
    public function setBaseUrl($baseUrl = null)
    {
        if ((null !== $baseUrl) &amp;&amp; !is_string($baseUrl)) {
            return $this;
        }

        if ($baseUrl === null) {
            $filename = (isset($_SERVER['SCRIPT_FILENAME'])) ? basename($_SERVER['SCRIPT_FILENAME']) : '';

            if (isset($_SERVER['SCRIPT_NAME']) &amp;&amp; basename($_SERVER['SCRIPT_NAME']) === $filename) {
                $baseUrl = $_SERVER['SCRIPT_NAME'];
            } elseif (isset($_SERVER['PHP_SELF']) &amp;&amp; basename($_SERVER['PHP_SELF']) === $filename) {
                $baseUrl = $_SERVER['PHP_SELF'];
            } elseif (isset($_SERVER['ORIG_SCRIPT_NAME']) &amp;&amp; basename($_SERVER['ORIG_SCRIPT_NAME']) === $filename) {
                $baseUrl = $_SERVER['ORIG_SCRIPT_NAME']; // 1and1 shared hosting compatibility
            } else {
                // Backtrack up the script_filename to find the portion matching
                // php_self
                $path    = isset($_SERVER['PHP_SELF']) ? $_SERVER['PHP_SELF'] : '';
                $file    = isset($_SERVER['SCRIPT_FILENAME']) ? $_SERVER['SCRIPT_FILENAME'] : '';
                $segs    = explode('/', trim($file, '/'));
                $segs    = array_reverse($segs);
                $index   = 0;
                $last    = count($segs);
                $baseUrl = '';
                do {
                    $seg     = $segs[$index];
                    $baseUrl = '/' . $seg . $baseUrl;
                    ++$index;
                } while (($last &gt; $index) &amp;&amp; (false !== ($pos = strpos($path, $baseUrl))) &amp;&amp; (0 != $pos));
            }

            // Does the baseUrl have anything in common with the request_uri?
            $requestUri = $this-&gt;getRequestUri();

            if (0 === strpos($requestUri, $baseUrl)) {
                // full $baseUrl matches
                $this-&gt;_baseUrl = $baseUrl;
                return $this;
            }

            if (0 === strpos($requestUri, dirname($baseUrl))) {
                // directory portion of $baseUrl matches
                $this-&gt;_baseUrl = rtrim(dirname($baseUrl), '/');
                return $this;
            }

            if (!strpos($requestUri, basename($baseUrl))) {
                // no match whatsoever; set it blank
                $this-&gt;_baseUrl = '';
                return $this;
            }

            // If using mod_rewrite or ISAPI_Rewrite strip the script filename
            // out of baseUrl. $pos !== 0 makes sure it is not matching a value
            // from PATH_INFO or QUERY_STRING
            if ((strlen($requestUri) &gt;= strlen($baseUrl))
                &amp;&amp; ((false !== ($pos = strpos($requestUri, $baseUrl))) &amp;&amp; ($pos !== 0)))
            {
                $baseUrl = substr($requestUri, 0, $pos + strlen($baseUrl));
            }
        }

        $this-&gt;_baseUrl = rtrim($baseUrl, '/');
        return $this;
    }

    /**
     * Everything in REQUEST_URI before PATH_INFO
     * &lt;form action="&lt;?=$baseUrl?&gt;/news/submit" method="POST"/&gt;
     *
     * @return string
     */
    public function getBaseUrl()
    {
        if (null === $this-&gt;_baseUrl) {
            $this-&gt;setBaseUrl();
        }

        return $this-&gt;_baseUrl;
    }
</pre>


<p>
通过这几个文件程序 实现了 routor ：
</p>
<pre>
http://myhost.com/app/index.php?module=default&amp;controller=index&amp;action=index&amp;var1=val1&amp;var2=val2
http://myhost.com/app/index.php/default/index/index/var1/val1/var2/val2
http://myhost.com/app/default/index/index/var1/val1/var2/val2
</pre>

</div>
<div id="footer">
    <p>
	<a href="http://creativecommons.org/licenses/by-nc-sa/2.5/" rel="license">
		<img src="http://creativecommons.org/images/public/somerights20.png" style="border-width: 0" alt="Creative Commons License">
	</a><br>
	本网站作品采用<a href="http://creativecommons.org/licenses/by-nc-sa/2.5/" rel="license">知识共享署名-非商业性使用-相同方式共享 2.5 许可协议</a>进行许可。<br> 
    &copy; 2011 sesehai &nbsp;&nbsp;
    </p>
</div>
</div>
<script src="../jquery-1.4.2.min.js" type="text/javascript"></script>
<script src="../vimwiki.js" type="text/javascript"></script>
</body>
</html>
