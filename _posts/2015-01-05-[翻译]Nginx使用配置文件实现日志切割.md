---
layout: post
category : 技术
tagline: ""
tags : [nginx,log,rotation,翻译]
title : 【翻译】Nginx使用配置文件实现日志切割
author: SSH
---

自从我发现，PostgreSQL 切割日志不再需要使用 logrotate 或者 cronolog，而是可以在log_filename 中使用变量来实现日志切割，就很希望nginx也能支持。

事实证明，nginx不仅可以并且很容易实现，从Nginx引进了在access_log中使用变量的指令(0.7.4版本添加)，和**$time_iso8601** 变量提供了ISO 8601格式的时间（0.9.6版本添加）

请注意，不能在**error_log**中使用变量，因为，当文件不可写时任何隐含的错误将不能被写入；

这里是$time_iso8601格式的实例：

    2014-05-04T18:12:02+02:00

可以使用“if”语句用正则表达式，取得需要的时间，设置到变量中使用。

按天分割日志，可以在服务上使用下面的语句片段：

    if ($time_iso8601 ~ "^(\d{4})-(\d{2})-(\d{2})") {
        set $year $1;
        set $month $2;
        set $day $3;
    }
    
    access_log /var/log/nginx/$year-$month-$day-access.log;

另外，我们也可以使用Perl兼容的正则表达式格式实现：

    if ($time_iso8601 ~ "^(?<year>\d{4})-(?<month>\d{2})-(?<day>\d{2})") {}
    
    access_log /var/log/nginx/$year-$month-$day-access.log;

要使用到时、分、秒，我们可以使用下面的片段：

    if ($time_iso8601 ~ "^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})")
    {
        set $year $1;
        set $month $2;
        set $day $3;
        set $hour $4;
        set $minutes $5;
        set $seconds $6;
    }

最后，再次强调，请确保Nginx进程拥有log目录的写权限。

目前这个方法已经应用到了生产环境中将近一个月了，nginx 访问量很大且运行的很正常。唯一的缺点是当access_log包含变量时缓存写入无法工作，所以在运行的时候不能把log打成压缩包。

[来源 >>](http://www.cambus.net/log-rotation-directly-within-nginx-configuration-file/)